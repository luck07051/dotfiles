#!/bin/sh

readlater_file="$HOME/bm/readlater"
browser_open="librewolf --new-tab"

add() {
	cur_tab="$(get-cur-tab)"
	[ -z "$cur_tab" ] && exit

	if grep "$cur_tab" "$readlater_file"; then
		notify-send "Readlater" "Already have this page!"
		exit
	fi

	echo "$cur_tab" >> "$readlater_file"
	notify-send "Readlater: Add page" "$(echo "$cur_tab" | cut -f1)"
}

pop() {
	selected="$(column -t -s "$(printf '\t')" "$readlater_file" | tac |
		dmenu -i -F -l 20 -p "Open page")"
	[ -z "$selected" ] && exit

	url="${selected##* }"

	$browser_open "$url"
}

rm() {
	# TODO: only get url
	tab="$(get-cur-tab)"

	if [ -z "$tab" ] || ! grep -q "$tab" "$readlater_file"; then
		tab="$(column -t -s "$(printf '\t')" "$readlater_file" | tac |
			dmenu -i -l 20 -p "Delete page" | sed 's/\s\+\(\S\+\)$/\t\1/')"
		echo "$tab"
		[ -z "$tab" ] && exit
	fi

	url="$(echo "$tab" | cut -f2 | sed 's#/#\\/#g')"
	sed -i "/.*\t$url/d" "$readlater_file"
	notify-send "Readlater: Delete page" "$(echo "$tab" | cut -f1)"
}

"$@"
