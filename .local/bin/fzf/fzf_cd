#!/bin/sh

# TODO:
#  preview window

cache_file="$HOME/.cache/fzf_cd_cache_file"

save_path() {
  printf "%s\n" "$1" >> "$cache_file"
}

del_path() {
  if [ -s "$cache_file" ] && [ "$(tail -n1 "$cache_file")" != ".." ]; then
    tmpfile=$(mktemp /tmp/fzf-cd.XXXXXX)
    trap 'rm "$tmpfile"' 0 1 15
    head -n -1 "$cache_file" > "$tmpfile" && mv "$tmpfile" "$cache_file"
  else
    printf "..\n" >> "$cache_file"
  fi
}

reload() {
  p="$(tr '\n' '/' < "$cache_file")"
  if [ -z "$p" ]; then
    /bin/ls -A --group-directories-first
  elif [ -d "$p" ]; then
    /bin/ls -A --group-directories-first "$p"
  else
    kill "$(pidof fzf)"
  fi
}

if [ -n "$1" ]; then
  "$@"
else
  # clean cache file
  : > "$cache_file"

  save='execute(fzf_cd save_path {})'
  reload='reload(fzf_cd reload)+clear-query+first'

  /bin/ls -A --group-directories-first | fzf --reverse \
      --bind "/:$save+$reload" \
      --bind "space:$save+$reload" \
      --bind "enter:$save+accept" \
      --bind "backward-eof:execute(fzf_cd del_path)+$reload" >/dev/null

  p="$(tr '\n' '/' < "$cache_file")"
  if [ -n "$p" ]; then
    if [ -d "$p" ]; then
      cd "$p"
    else
      cd "$(dirname "$p")"
      file="$(basename "$p")"
      # case $file
      $EDITOR "$file"
    fi
  fi
fi
