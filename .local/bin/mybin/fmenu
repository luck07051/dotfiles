#!/bin/sh

if [ $(pgrep -c "$(basename "$0")") -gt 1 ]; then
	echo 'Other fmenu is running!' >&2
	exit 1
fi

default_fzf_opt='--height=100% --layout=reverse --color=gutter:-1,pointer:5 --no-separator --info=inline --ansi --bind=enter:replace-query+print-query,alt-enter:print-query,tab:replace-query'
prompt="> "
line="25"
column="50"
fzf_opt=""
fontsize='20'

# parse options
TEMP=$(getopt -o 'p:l:c:f:z:' -n "$0" -- "$@")
[ $? -ne 0 ] && echo 'Parsing options error!' >&2 && exit 1
eval set -- "$TEMP"
unset TEMP

while :; do
	case "$1" in
		'-p') prompt="$2";   shift 2 ;;
		'-l') line="$2";     shift 2 ;;
		'-c') column="$2";   shift 2 ;;
		'-f') fzf_opt="$2";  shift 2 ;;
		'-z') fontsize="$2"; shift 2 ;;
		'--') break ;;
		*)    echo 'Internal error!' >&2; exit 1 ;;
	esac
done

${TERMINAL:-st} -t "$(basename "$0")" -g "${column}x${line}" -z "$fontsize" -c float \
	-e sh -c "fzf $default_fzf_opt --prompt \"$prompt \" $fzf_opt </proc/$$/fd/0 >/proc/$$/fd/1"
