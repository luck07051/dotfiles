#!/bin/sh

BOOKMARKS_FILE="$HOME/bookmarks"
SPACES=40

pick_url() {
  option="$(cat <<EOF
add bookmark
EOF
)"

  chosen="$(printf "%s\n%s" \
    "$(sed "/^\s*\(#\)\|\(--\)/d; /^\$/d" "$BOOKMARKS_FILE")" \
    "$option" \
      | dmenu -i -l 20 -p 'OPEN')"

  [ -z "$chosen" ] && exit 1

  case "$chosen" in
    "add bookmark")
      "$0" add_bookmark
      ;;

    *)
      if grep -qF "$chosen" "$BOOKMARKS_FILE"; then
        echo "${chosen##* }"
      else
        engine="$(grep "^\s*--\s*${chosen%% *}\s" "$BOOKMARKS_FILE")"
        if [ -n "$engine" ]; then
          echo "${engine##* }" | sed "s/{}/${chosen#* }/g; s/\s/+/g"
        else
          engine="$(grep "^\s*--\s*DEFAULT" "$BOOKMARKS_FILE")"
          echo "${engine##* }" | sed "s/{}/$chosen/g; s/\s/+/g"
        fi
      fi
      ;;
  esac
}

open_in_new_tab() {
  [ -z "$1" ] && exit 1

  firefox -new-tab "$@"
}

open_in_current_tab() {
  [ -z "$1" ] && exit 1

  winid="$(xdotool search --name --class --classname --role "Navigator")"
  [ -z "$winid" ] && exit 1

  cur_clip="$(xclip -o -selection clipboard)"
  echo "$@" | xclip -i -selection clipboard

  xdotool key --clearmodifiers --window "$winid" ctrl+l ctrl+v Return

  echo "$cur_clip" | xclip -i -selection clipboard
}

open_smarter() {
  if [ "$(xdotool getwindowclassname "$(xdotool getwindowfocus)")" = 'firefox' ]; then
    open_in_current_tab "$(pick_url)"
  else
    open_in_new_tab "$(pick_url)"
  fi
}

get_current_url() {
  # cur_clip="$(xclip -o -selection clipboard)"

  winid="$(xdotool search --name --class --classname --role "Navigator")"
  [ -z "$winid" ] && exit 1

  xdotool key --clearmodifiers --window "$winid" ctrl+l ctrl+c Escape
  # conceal selection of url bar
  xdotool click --clearmodifiers --window "$winid" 3
  xdotool click --clearmodifiers --window "$winid" 1

  xclip -o -selection clipboard
  # printf "%s" "$cur_clip" | xclip -selection clipboard
}

add_bookmark() {
  url="$(get_current_url)"
  [ -z "$url" ] && exit 1

  winid="$(xdotool search --name --class --classname --role "Navigator")"
  [ -z "$winid" ] && exit 1

  name="$(xdotool getwindowname "$winid" | sed 's/\sâ€”.*\?$//' | dmenu -p "Enter bookmark name:")"
  [ -z "$name" ] && exit

  printf "%-$((SPACES - 1))s %s\n" "$name" "$url" >> "$BOOKMARKS_FILE"
}

if [ -z "$1" ]; then
  open_smarter
else
  case $1 in
    new_tab)
      open_in_new_tab "$(pick_url)"
      ;;

    current_tab)
      open_in_current_tab "$(pick_url)"
      ;;

    add_bookmark)
      add_bookmark
      ;;
  esac
fi
