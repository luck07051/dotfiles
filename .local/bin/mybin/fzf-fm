#!/bin/sh

# File browser using fzf.
# Adding `source fzf-fm` in your shellrc. And run command 'fzf_fm'

if type lsd >/dev/null; then
	_fzf_fm_lscmd='lsd -A --group-directories-first --color=always'
elif type exa >/dev/null; then
	_fzf_fm_lscmd='exa -a --group-directories-first --icons --color=always'
else
	_fzf_fm_lscmd='ls -A --group-directories-first --color=always'
fi

if type preview >/dev/null 2>&1; then
	_fzf_fm_preview_cmd='preview $PWD/{}'
else
	_fzf_fm_preview_cmd="
if [ -d \$PWD/{} ]; then
	$_fzf_fm_lscmd \$PWD/{}
else
	cat \$PWD/{}
fi"
fi

fzf_fm(){
	_fzf_fm_temp_file='/tmp/fzf-fm-up-dir'

	while :; do
		selected="$($_fzf_fm_lscmd "$PWD" |
			fzf --prompt "$PWD/" \
			--preview "$_fzf_fm_preview_cmd" \
			--preview-window '70%,border-left' \
			--ansi \
			--height 100 \
			--info inline \
			--color prompt:245 \
			--cycle \
			--bind left:"execute(touch $_fzf_fm_temp_file)+abort",right:accept \
			--bind ctrl-h:"execute(touch $_fzf_fm_temp_file)+abort",ctrl-l:accept
		)"

		if [ -f "$_fzf_fm_temp_file" ]; then
			rm -f "$_fzf_fm_temp_file"
			cd ..
			continue
		fi

		[ -z "$selected" ] && return

		file="$PWD/$selected"
		if [ -d "$file" ]; then
			cd "$file" || exit
		elif type open >/dev/null 2>&1; then
			open "$file"
		else
			$EDITOR "$file"
		fi
	done
}
