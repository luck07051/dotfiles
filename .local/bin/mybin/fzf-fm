#!/bin/sh

# in your shellrc: `source fzf-fm`
# and type `a` to use.

if type preview >/dev/null; then
	preview_cmd='preview $PWD/{}'
else
	preview_cmd='
if [ -d $PWD/{} ]; then
	ls -a $PWD/{}
else
	cat $PWD/{}
fi'
fi

a(){
	[ -n "$1" ] && { cd "$1"; return; }
	temp="$(mktemp)"

	while :; do
		ls "$PWD" -A --group-directories-first --color=always |
			fzf --prompt "$PWD/" --preview "$preview_cmd" \
			--preview-window '70%,border-left' \
			--ansi --height 100 --info inline --color prompt:245 \
			--bind left:"execute(echo '..' >$temp)+abort",right:accept \
			--bind ctrl-h:"execute(echo '..' >$temp)+abort",ctrl-l:accept \
			>"$temp"

		if [ -z "$(cat "$temp")" ]; then
			rm "$temp"
			return
		fi

		file=$PWD/$(cat "$temp")
		if [ -d $file ]; then
			cd "$file"
		else
			open "$file"
		fi
	done
}
